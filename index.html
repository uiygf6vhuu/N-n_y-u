<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Trang T√¨nh Y√™u B√≠ M·∫≠t üíï</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* CSS CƒÇN CH·ªàNH CHO TYM 4 V√Ä FLOW M·ªöI */
        html, body {
            height: 100%;
            padding: 0;
            margin: 0;
            background-color: #000;
            overflow: hidden; /* Quan tr·ªçng: ƒê·∫£m b·∫£o ch·ªâ th·∫•y Canvas ban ƒë·∫ßu */
            font-family: 'Arial', sans-serif;
        }

        /* 1. CANVAS TYM 4 (Hi·ªáu ·ª©ng n·ªÅn) */
        #heart {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 10;
        }
        
        /* 2. KHU V·ª∞C K√çCH HO·∫†T (Tr√°i tim ƒë·ªÉ click) */
        #enterPrompt {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50; /* N·∫±m tr√™n canvas */
            cursor: pointer;
            font-size: 8em; /* K√≠ch th∆∞·ªõc tr√°i tim */
            animation: pulse 1.5s infinite; /* Hi·ªáu ·ª©ng nh·∫•p nh√°y ƒë·ªÉ thu h√∫t */
            color: #ff69b4;
            text-shadow: 0 0 10px #ff007f;
            transition: opacity 0.5s;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.05); opacity: 0.9; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* 3. M√ÄN H√åNH ƒêƒÇNG NH·∫¨P (Ban ƒë·∫ßu ·∫©n) */
        .login-container-new {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.1);
            max-width: 400px;
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* Hi·ªáu ·ª©ng ph√≥ng to */
        }
        .login-container-new.visible {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }
        .password-input { font-size: 1.2em; padding: 15px; width: 100%; margin: 20px 0; border: 2px solid #ff6b6b; border-radius: 10px; text-align: center; }

        /* 4. N·ªòI DUNG CH√çNH (Sau khi ƒëƒÉng nh·∫≠p) */
        #mainContent {
            display: none; /* Ban ƒë·∫ßu ·∫©n */
            background: linear-gradient(135deg, #ffafbd, #ffc3a0); /* N·ªÅn nh·∫π nh√†ng h∆°n */
            min-height: 100vh;
            overflow-y: auto;
            position: relative;
            z-index: 10;
        }

        /* CSS M·∫∂C ƒê·ªäNH CHO N·ªòI DUNG CH√çNH (T·ª™ style.css) */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; animation: fadeIn 1s ease-in;}
        .message-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 10px; background: rgba(255,255,255,0.7); padding: 10px;}
        /* ... th√™m c√°c CSS kh√°c t·ª´ style.css n·∫øu c·∫ßn ... */
    </style>
</head>

<body style="background-color: #000;">
    
    <canvas id="heart"></canvas> 

    <div id="enterPrompt" onclick="showLogin()">
        üíñ
    </div>

    <div id="loginScreen" class="login-container-new">
        <h1>üîë C·ªïng B√≠ M·∫≠t üîë</h1>
        <p>B·∫•m tr√°i tim ƒë·ªÉ v√†o trang, gi·ªù h√£y nh·∫≠p m·∫≠t kh·∫©u:</p>
        <input type="password" id="sitePassword" class="password-input" placeholder="M·∫≠t kh·∫©u b√≠ m·∫≠t" autocomplete="off">
        <button class="btn" onclick="login()">ƒêƒÉng Nh·∫≠p</button>
    </div>

    <div id="mainContent" class="container" style="display: none;">
        <h1>Trang T√¨nh Y√™u C·ªßa Ch√∫ng Ta!</h1>
        <div class="navigation">
            <button class="btn" onclick="loadContent()">T·∫£i l·∫°i n·ªôi dung</button>
            <a href="admin.html" class="btn" style="background: #2ed573;">üîí Qu·∫£n tr·ªã vi√™n</a>
            <a href="game.html" class="btn" style="background: #3742fa;">üéÆ Game T√¨nh Y√™u</a>
            <button class="btn" onclick="logout()" style="background: #ff4757;">üö™ Tho√°t</button>
        </div>
        
        <h2>üíå Tin nh·∫Øn Y√™u Th∆∞∆°ng</h2>
        <div id="messageDisplay" class="message-list">
            <p class="no-content">ƒêang t·∫£i tin nh·∫Øn...</p>
        </div>

        <h2>‚úçÔ∏è G·ª≠i Tin nh·∫Øn M·ªõi</h2>
        <div class="admin-section">
            <textarea id="newMessage" class="message-input" placeholder="Vi·∫øt m·ªôt tin nh·∫Øn ƒë√°ng y√™u..."></textarea>
            <button class="btn" onclick="addMessage()">G·ª≠i Tin Nh·∫Øn</button>
        </div>
        
        <h2>‚è±Ô∏è Ng√†y ƒê·∫∑c Bi·ªát</h2>
        <p id="countdown" style="font-size: 2em; color: #dc143c; font-weight: bold;"></p>
        
        <h2>üñºÔ∏è Kho·∫£nh Kh·∫Øc</h2>
        <div style="text-align: center;">
            <img id="loveImage" class="love-image" src="" alt="·∫¢nh T√¨nh Y√™u" style="display: none;">
            <p id="noImage" class="no-content" style="display: none;">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c t·∫£i l√™n.</p>
        </div>
        
        <div style="height: 50px;"></div>
    </div>

    <script>
        // =========================================================
        // JAVASCRIPT G·ªêC CHO HI·ªÜU ·ª®NG TR√ÅI TIM 4 (TYM 4) - ƒê√£ s·ª≠a l·ªói
        // VUI L√íNG D√ÅN TO√ÄN B·ªò CODE JS T·ª™ FILE index4.html C·ª¶A B·∫†N V√ÄO ƒê√ÇY
        // =========================================================

        window.requestAnimationFrame =
            window.__requestAnimationFrame ||
            window.requestAnimationFrame ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame ||
            window.oRequestAnimationFrame ||
            window.msRequestAnimationFrame ||
            (function () {
                return function (callback, element) {
                    var lastTime = element.__lastTime;
                    if (lastTime === undefined) {
                        lastTime = 0;
                    }
                    var currTime = Date.now();
                    var timeToCall = Math.max(1, 33 - (currTime - lastTime));
                    window.setTimeout(callback, timeToCall);
                    element.__lastTime = currTime + timeToCall;
                };
            })();
        window.isDevice = (/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(((navigator.userAgent || navigator.vendor || window.opera).toLowerCase())));
        var w = window.innerWidth,
            h = window.innerHeight,
            canvas = document.getElementById('heart'),
            ctx = canvas.getContext('2d'),
            rate = 0.5,
            arc = 100,
            time,
            count,
            size = 7,
            speed = 20,
            parts = [],
            colors = ['#ff69b4', '#ff007f', '#ea80b0', '#ffc0cb', '#ff99aa'],
            random = function (min, max) {
                return Math.random() * (max - min) + min;
            };
        canvas.setAttribute('width', w);
        canvas.setAttribute('height', h);
        var Heart = function (x, y) {
            this.x = x || random(0, w);
            this.y = y || random(0, h);
            this.size = random(1, size);
            this.speed = random(1, speed);
            this.step = random(0, Math.PI * 2);
            this.arc = random(0, Math.PI * 2);
            this.D = random(10, arc);
            this.color = colors[Math.floor(random(0, colors.length))];
            this.update = function () {
                this.step += rate;
                this.x = Math.sin(this.step) * this.D + x;
                this.y = Math.cos(this.step) * this.D + y;
            };
            this.draw = function () {
                var heart = [
                    [-6, -6],
                    [-16, -2],
                    [-20, 1],
                    [-14, 8],
                    [-4, 16],
                    [6, 8],
                    [12, 1],
                    [8, -2],
                    [0, -6],
                ];
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(this.x + heart[0][0] * this.size / 7, this.y + heart[0][1] * this.size / 7);
                for (var i = 1; i < heart.length; i++) {
                    ctx.lineTo(this.x + heart[i][0] * this.size / 7, this.y + heart[i][1] * this.size / 7);
                }
                ctx.closePath();
                ctx.fill();
            };
        };
        var loop = function () {
            requestAnimationFrame(loop, canvas);
            ctx.clearRect(0, 0, w, h);
            if (count > parts.length) {
                if (count % 3 === 0) {
                    var newHeart = new Heart(w / 2, h / 2);
                    newHeart.size = random(5, 12);
                    parts.push(newHeart);
                }
            } else if (count < parts.length) {
                parts.splice(0, 1);
            }
            if (count > 0) {
                count -= 0.5;
            }
            for (var i = 0; i < parts.length; i++) {
                parts[i].update();
                parts[i].draw();
            }
        };
        function setup() {
            for (var i = 0; i < 20; i++) {
                parts.push(new Heart(w / 2, h / 2));
            }
            count = 50;
        }
        window.addEventListener('resize', function () {
            w = window.innerWidth;
            h = window.innerHeight;
            canvas.setAttribute('width', w);
            canvas.setAttribute('height', h);
            parts.splice(0, parts.length);
            setup();
        });
        document.getElementById('heart').addEventListener('click', function (e) {
            var x = e.clientX;
            var y = e.clientY;
            for (var i = 0; i < 15; i++) {
                parts.push(new Heart(x, y));
            }
            count = 50;
        });
        setup();
        loop();

        // =========================================================
        // LOGIC ƒêƒÇNG NH·∫¨P V√Ä CHUY·ªÇN TRANG
        // =========================================================

        let isAuthenticated = false;
        let sitePassword = localStorage.getItem('sitePassword');

        // H√†m hi·ªÉn th·ªã khung ƒëƒÉng nh·∫≠p
        function showLogin() {
            document.getElementById('enterPrompt').style.opacity = '0';
            setTimeout(() => {
                 document.getElementById('enterPrompt').style.display = 'none';
                 document.getElementById('loginScreen').classList.add('visible');
            }, 500);
        }

        async function login() {
            const passwordInput = document.getElementById('sitePassword');
            const password = passwordInput.value;

            try {
                const response = await fetch('/api/check-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (data.success) {
                    isAuthenticated = true;
                    sitePassword = password;
                    localStorage.setItem('sitePassword', password);
                    
                    // ·∫®n hi·ªáu ·ª©ng Tym 4 v√† khung ƒëƒÉng nh·∫≠p
                    document.getElementById('heart').style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'none';
                    
                    // Hi·ªán n·ªôi dung ch√≠nh
                    document.getElementById('mainContent').style.display = 'block';
                    loadContent(); 
                } else {
                    alert('Sai m·∫≠t kh·∫©u. H√£y th·ª≠ l·∫°i!');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi server: ' + error.message);
            }
        }

        async function loadContent() {
            if (!sitePassword) return;

            try {
                // T·∫£i tin nh·∫Øn
                const msgResponse = await fetch('/api/messages', {
                    headers: { 'Authorization': sitePassword }
                });
                
                // T·∫£i ·∫£nh k·ª∑ ni·ªám (gi·ªëng logic c≈©)
                const imgResponse = await fetch('/api/love-image', {
                    headers: { 'Authorization': sitePassword }
                });
                
                if (msgResponse.ok) {
                    const data = await msgResponse.json();
                    const container = document.getElementById('messageDisplay');
                    container.innerHTML = '';
                    
                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach((msg) => {
                            const p = document.createElement('p');
                            p.style.cssText = 'background: #ffe6e6; padding: 10px; margin: 5px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);';
                            p.innerHTML = `üí¨ ${msg}`;
                            container.appendChild(p);
                        });
                    } else {
                        container.innerHTML = '<p class="no-content">Ch∆∞a c√≥ tin nh·∫Øn n√†o.</p>';
                    }
                }

                if (imgResponse.ok) {
                    const imgData = await imgResponse.json();
                    const loveImage = document.getElementById('loveImage');
                    const noImage = document.getElementById('noImage');
                    
                    if (imgData.image) {
                        loveImage.src = imgData.image;
                        loveImage.style.display = 'block';
                        noImage.style.display = 'none';
                    } else {
                        loveImage.style.display = 'none';
                        noImage.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('L·ªói t·∫£i d·ªØ li·ªáu:', error);
                alert('L·ªói t·∫£i d·ªØ li·ªáu! Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }
        
        async function addMessage() {
            const messageInput = document.getElementById('newMessage');
            const message = messageInput.value.trim();

            if (!message) {
                alert("Vui l√≤ng nh·∫≠p tin nh·∫Øn!");
                return;
            }

            try {
                const response = await fetch('/api/messages', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': sitePassword
                    },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();

                if (data.success) {
                    messageInput.value = ''; // X√≥a n·ªôi dung sau khi g·ª≠i
                    loadContent(); // T·∫£i l·∫°i ƒë·ªÉ th·∫•y tin nh·∫Øn m·ªõi
                    alert('ƒê√£ g·ª≠i tin nh·∫Øn y√™u th∆∞∆°ng th√†nh c√¥ng!');
                } else {
                    alert('L·ªói khi g·ª≠i tin nh·∫Øn: ' + (data.error || 'Vui l√≤ng ki·ªÉm tra l·∫°i m·∫≠t kh·∫©u.'));
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi server: ' + error.message);
            }
        }

        function logout() {
            isAuthenticated = false;
            sitePassword = '';
            localStorage.removeItem('sitePassword');
            
            // Hi·ªán l·∫°i Tym 4 v√† prompt
            document.getElementById('heart').style.display = 'block';
            document.getElementById('enterPrompt').style.display = 'block';
            document.getElementById('enterPrompt').style.opacity = '1';
            
            // ·∫®n khung ƒëƒÉng nh·∫≠p v√† n·ªôi dung ch√≠nh
            document.getElementById('loginScreen').classList.remove('visible');
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('sitePassword').value = '';
        }

        // --- KH·ªûI T·∫†O ---
        document.addEventListener('DOMContentLoaded', () => {
            if (sitePassword) {
                // N·∫øu ƒë√£ c√≥ m·∫≠t kh·∫©u, ·∫©n Tym 4 v√† hi·ªán n·ªôi dung ch√≠nh lu√¥n
                document.getElementById('heart').style.display = 'none';
                document.getElementById('enterPrompt').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                loadContent(); 
            } else {
                 // Hi·ªán Tym 4 v√† Prompt, ·∫©n c√°c th√†nh ph·∫ßn kh√°c
                 document.getElementById('heart').style.display = 'block';
                 document.getElementById('enterPrompt').style.display = 'block';
                 document.getElementById('loginScreen').style.display = 'none';
                 document.getElementById('mainContent').style.display = 'none';
            }
        });

        // Enter ƒë·ªÉ ƒëƒÉng nh·∫≠p
        document.getElementById('sitePassword').addEventListener('keypress', function(e) {
             if (e.key === 'Enter') login();
        });
    </script>
</body>
</html>
