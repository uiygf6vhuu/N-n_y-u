<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Trang T√¨nh Y√™u B√≠ M·∫≠t üíï</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Bi·∫øn CSS cho m√†u tr√°i tim */
        :root {
            --heart-color: #dc143c; 
        }

        /* 1. CANVAS TYM 4 (Splash Screen) */
        #tym4-frame {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 100; 
            transition: all 1.5s ease-in-out; 
            overflow: hidden;
            pointer-events: auto; /* LU√îN B·∫¨T CH·∫æ ƒê·ªò B·∫§M CHO TYM 4 */
            background: #000; 
            cursor: pointer;
        }

        #tym4-canvas {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        /* Tr·∫°ng th√°i THU NH·ªé sau khi b·∫•m */
        #tym4-frame.shrink {
            width: 150px;
            height: 150px;
            top: 10px;
            left: 10px;
            border-radius: 50%;
            opacity: 0.8;
            animation: pulse-small 1.5s infinite; 
            pointer-events: none; /* T·∫Øt click sau khi thu nh·ªè */
        }
        @keyframes pulse-small {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* 2. M√ÄN H√åNH ƒêƒÇNG NH·∫¨P (L·ªõp ·∫©n/hi·ªán) */
        .login-container {
            max-width: 400px;
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 200; /* N·ªïi tr√™n Tym 4 */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.1); /* B·∫Øt ƒë·∫ßu nh·ªè */
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .login-container.visible {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1); /* Ph√≥ng to */
        }
        .password-input { font-size: 1.2em; padding: 15px; width: 100%; margin: 20px 0; border: 2px solid #ff6b6b; border-radius: 10px; text-align: center; }

        /* 3. N·ªòI DUNG CH√çNH */
        #mainContent {
            display: none;
            background: linear-gradient(135deg, #ffafbd, #ffc3a0);
            min-height: 100vh;
            overflow-y: auto;
            position: relative;
            z-index: 10; 
        }

        /* KHU V·ª∞C TH√îNG B√ÅO V√Ä N·ªòI DUNG */
        .notification-prompt {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 105;
            background: rgba(255, 255, 255, 0.85);
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: bold;
            color: #dc143c;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    
    <div id="tym4-frame" onclick="handleTym4Click()">
        <canvas id="tym4-canvas"></canvas>
    </div>
    
    <div id="clickPrompt" class="notification-prompt">
        üíñ B·∫•m v√†o tr√°i tim ƒë·ªÉ v√†o trang üíñ
    </div>

    <div id="loginScreen" class="login-container">
        <h1>üîë C·ªïng B√≠ M·∫≠t üîë</h1>
        <p>Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u:</p>
        <input type="password" id="sitePassword" class="password-input" placeholder="M·∫≠t kh·∫©u b√≠ m·∫≠t" autocomplete="off">
        <button class="btn" onclick="login()">ƒêƒÉng Nh·∫≠p</button>
    </div>

    <div id="mainContent" class="container">
        <h1>Trang T√¨nh Y√™u C·ªßa Ch√∫ng Ta!</h1>
        <div id="countdown" class="countdown"></div>

        <h2>üíå Nh·ªØng l·ªùi y√™u th∆∞∆°ng</h2>
        <ul id="messageList" class="message-list"></ul>
        
        <div class="tym-links" style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #ffafbd;">
            <h2>‚ú® Kh√°m Ph√° C√°c K·ª∑ Ni·ªám (C√≥ ·∫¢nh)</h2>
            <p>Ch·ªçn m·ªôt ki·ªÉu tr√°i tim ƒë·ªÉ xem ·∫£nh k·ª∑ ni·ªám:</p>
            <a href="index_tym1.html" class="btn" style="background: linear-gradient(45deg, #dc143c, #b3002d);">Vi·ªÅn 1 (M·∫°nh m·∫Ω)</a>
            <a href="index_tym2.html" class="btn" style="background: linear-gradient(45deg, #ff69b4, #e84c8e);">Vi·ªÅn 2 (Bay nh·∫π)</a>
            <a href="index_tym3.html" class="btn" target="_blank" style="background: linear-gradient(45deg, #9370db, #7b59bf);">Vi·ªÅn 3 (C·ªï ƒëi·ªÉn)</a>
        </div>

        <div class="navigation" style="margin-top: 40px; text-align: center;">
            <a href="/game" class="btn" style="background: #2ed573;">üéÆ Ch∆°i Game T√¨nh Y√™u</a>
            <button class="btn" onclick="logout()" style="background: #ff4757;">üö™ Kh√≥a Trang</button>
        </div>
    </div>

    <script>
        // --- C√ÅC H·∫∞NG S·ªê C·∫§U H√åNH ---
        const TARGET_DATE = new Date("2024-03-08T00:00:00").getTime();
        
        let isAuthenticated = false;
        let sitePassword = localStorage.getItem('sitePassword');
        let loginAttempted = false; // C·ªù b√°o hi·ªáu ƒë√£ th·ª≠ ƒëƒÉng nh·∫≠p nh∆∞ng ch∆∞a th√†nh c√¥ng

        // =========================================================
        // LOGIC B·∫§M V√ÄO TYM 4 ƒê·ªÇ M·ªû KHUNG ƒêƒÇNG NH·∫¨P
        // =========================================================
        function handleTym4Click() {
            if (isAuthenticated) return; // Kh√¥ng l√†m g√¨ n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p

            // ·∫®n prompt v√† cho khung ƒëƒÉng nh·∫≠p hi·ªán ra
            document.getElementById('clickPrompt').style.display = 'none';
            document.getElementById('loginScreen').classList.add('visible');
        }

        // =========================================================
        // LOGIC ƒêƒÇNG NH·∫¨P V√Ä THU NH·ªé
        // =========================================================

        async function login() {
            const passwordInput = document.getElementById('sitePassword');
            const password = passwordInput.value;
            loginAttempted = true;

            try {
                const response = await fetch('/api/check-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (data.success) {
                    isAuthenticated = true;
                    sitePassword = password;
                    localStorage.setItem('sitePassword', password);
                    
                    // ·∫®n khung ƒëƒÉng nh·∫≠p
                    document.getElementById('loginScreen').classList.remove('visible');
                    
                    // CH·ªú 0.5s CHO HI·ªÜU ·ª®NG THU NH·ªé XONG R·ªíI M·ªöI HI·ªÜN N·ªòI DUNG CH√çNH
                    setTimeout(() => {
                        // 1. THU NH·ªé HI·ªÜU ·ª®NG TYM 4
                        document.getElementById('tym4-frame').classList.add('shrink'); 
                        
                        // 2. HI·ªÜN N·ªòI DUNG CH√çNH
                        document.getElementById('mainContent').style.display = 'block';
                        loadContent();
                    }, 500); 
                    
                } else {
                    alert('Sai m·∫≠t kh·∫©u. H√£y th·ª≠ l·∫°i!');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi server! Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        function logout() {
            isAuthenticated = false;
            loginAttempted = false;
            sitePassword = '';
            localStorage.removeItem('sitePassword');
            
            // ·∫®n n·ªôi dung ch√≠nh v√† ph·ª•c h·ªìi Tym 4
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('tym4-frame').classList.remove('shrink'); 
            document.getElementById('sitePassword').value = '';
            
            // Hi·ªán l·∫°i Prompt (ch·ªù Tym 4 ph·ª•c h·ªìi xong)
            setTimeout(() => {
                document.getElementById('clickPrompt').style.display = 'block';
            }, 1000);
        }
        
        // ... (C√°c h√†m loadContent, updateCountdown, v√† Tym 4 logic gi·ªØ nguy√™n) ...
        
        // LOGIC TYM 4 G·ªêC (ƒê∆∞·ª£c tr√≠ch xu·∫•t t·ª´ index_tym4.html)
        const tym4Canvas = document.getElementById('tym4-canvas');
        
        function initTym4() {
             // ... (ƒê·∫∑t code Tym 4 g·ªëc v√†o ƒë√¢y) ...
             // T√îI L∆Ø·ª¢C B·ªöT ƒêO·∫†N N√ÄY ƒê·ªÇ TI·∫æT KI·ªÜM CH·ªñ, H√ÉY D√ÅN CODE ƒê·∫¶Y ƒê·ª¶ V√ÄO PH·∫¶N <script> C·ª¶A B·∫†N.
             window.isDevice = (/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(((navigator.userAgent || navigator.vendor || window.opera)).toLowerCase()));
             var koef = window.isDevice ? 0.5 : 1;
             var ctx = tym4Canvas.getContext('2d');
             var width = tym4Canvas.width = koef * innerWidth;
             var height = tym4Canvas.height = koef * innerHeight;
             var rand = Math.random;

             var heartPosition = function (rad) {
                 return [Math.pow(Math.sin(rad), 3), -(15 * Math.cos(rad) - 5 * Math.cos(2 * rad) - 2 * Math.cos(3 * rad) - Math.cos(4 * rad))];
             };
             var scaleAndTranslate = function (pos, sx, sy, dx, dy) {
                 return [dx + pos[0] * sx, dy + pos[1] * sy];
             };

             var traceCount = window.isDevice ? 20 : 50;
             var pointsOrigin = [];
             var i;
             var dr = window.isDevice ? 0.3 : 0.1;
             for (i = 0; i < Math.PI * 2; i += dr) pointsOrigin.push(scaleAndTranslate(heartPosition(i), 210, 13, 0, 0));
             for (i = 0; i < Math.PI * 2; i += dr) pointsOrigin.push(scaleAndTranslate(heartPosition(i), 150, 9, 0, 0));
             for (i = 0; i < Math.PI * 2; i += dr) pointsOrigin.push(scaleAndTranslate(heartPosition(i), 90, 5, 0, 0));
             var heartPointsCount = pointsOrigin.length;

             var targetPoints = [];
             var pulse = function (kx, ky) {
                 for (i = 0; i < pointsOrigin.length; i++) {
                     targetPoints[i] = [];
                     targetPoints[i][0] = kx * pointsOrigin[i][0] + tym4Canvas.width / 2;
                     targetPoints[i][1] = ky * pointsOrigin[i][1] + tym4Canvas.height / 2;
                 }
             };

             var e = [];
             for (i = 0; i < heartPointsCount; i++) {
                 var x = rand() * width;
                 var y = rand() * height;
                 e[i] = {
                     vx: 0,
                     vy: 0,
                     R: 2,
                     speed: rand() + 5,
                     q: ~~(rand() * heartPointsCount),
                     D: 2 * (i % 2) - 1,
                     force: 0.2 * rand() + 0.7,
                     f: "hsla(330," + ~~(40 * rand() + 60) + "%," + ~~(60 * rand() + 50) + "%,.3)",
                     trace: []
                 };
                 for (var k = 0; k < traceCount; k++) e[i].trace[k] = {x: x, y: y};
             }

             var config = {
                 traceK: 0.4,
                 timeDelta: 0.01
             };

             var time = 0;
             
             function loopTym4() {
                 var n = -Math.cos(time);
                 pulse((1 + n) * .5, (1 + n) * .5);
                 time += ((Math.sin(time)) < 0 ? 9 : (n > 0.8) ? .2 : 1) * config.timeDelta;
                 
                 ctx.fillStyle = "rgba(0,0,0,.08)"; 
                 ctx.fillRect(0, 0, tym4Canvas.width, tym4Canvas.height);
                 
                 for (i = e.length; i--;) {
                     var u = e[i];
                     var q = targetPoints[u.q];
                     var dx = u.trace[0].x - q[0];
                     var dy = u.trace[0].y - q[1];
                     var length = Math.sqrt(dx * dx + dy * dy);
                     if (10 > length) {
                         if (0.95 < rand()) {
                             u.q = ~~(rand() * heartPointsCount);
                         }
                         else {
                             if (0.99 < rand()) {
                                 u.D *= -1;
                             }
                             u.q += u.D;
                             u.q %= heartPointsCount;
                             if (0 > u.q) {
                                 u.q += heartPointsCount;
                             }
                         }
                     }
                     u.vx += -dx / length * u.speed;
                     u.vy += -dy / length * u.speed;
                     u.trace[0].x += u.vx;
                     u.trace[0].y += u.vy;
                     u.vx *= u.force;
                     u.vy *= u.force;
                     for (k = 0; k < u.trace.length - 1;) {
                         var T = u.trace[k];
                         var N = u.trace[++k];
                         N.x -= config.traceK * (N.x - T.x);
                         N.y -= config.traceK * (N.y - T.y);
                     }
                     ctx.fillStyle = u.f;
                     for (k = 0; k < u.trace.length; k++) {
                         ctx.fillRect(u.trace[k].x, u.trace[k].y, 1, 1);
                     }
                 }
                 window.requestAnimationFrame(loopTym4, tym4Canvas);
             };

             window.addEventListener('resize', function () {
                 width = tym4Canvas.width = koef * innerWidth;
                 height = tym4Canvas.height = koef * innerHeight;
                 ctx.fillStyle = "rgba(0,0,0,1)";
                 ctx.fillRect(0, 0, width, height);
             });
             
             tym4Canvas.width = innerWidth;
             tym4Canvas.height = innerHeight;
             loopTym4();
         }
        
        // ... (H√†m loadContent, updateCountdown gi·ªØ nguy√™n) ...
        
        async function loadContent() {
            if (!sitePassword) return;

            try {
                // T·∫£i tin nh·∫Øn
                const msgResponse = await fetch('/api/love-messages', {
                    headers: { 'Authorization': sitePassword }
                });

                if (msgResponse.ok) {
                    const data = await msgResponse.json();
                    const container = document.getElementById('messageList');
                    container.innerHTML = '';
                    
                    if (data.messages && data.messages.length > 0) {
                        data.messages.reverse().forEach(msg => {
                            const li = document.createElement('li');
                            li.textContent = `üíù ${msg}`;
                            container.appendChild(li);
                        });
                    } else {
                        container.innerHTML = '<p class="no-content">Ch∆∞a c√≥ tin nh·∫Øn y√™u th∆∞∆°ng n√†o ƒë∆∞·ª£c g·ª≠i.</p>';
                    }
                }
            } catch (error) {
                console.error('L·ªói t·∫£i d·ªØ li·ªáu:', error);
                if (error.message.includes('401')) {
                    logout();
                    alert('Phi√™n l√†m vi·ªác h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                }
            }
        }
        
        function updateCountdown() {
             const TARGET_DATE = new Date("2024-03-08T00:00:00").getTime(); // Thay ƒë·ªïi ng√†y n√†y!
             const now = new Date().getTime();
             const distance = TARGET_DATE - now;
             const countdownEl = document.getElementById('countdown');

             if (distance < 0) {
                 countdownEl.innerHTML = "üéâ **K·ª∑ ni·ªám c·ªßa ch√∫ng ta!** üéâ";
                 return;
             }

             const days = Math.floor(distance / (1000 * 60 * 60 * 24));
             const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
             const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
             const seconds = Math.floor((distance % (1000 * 60)) / 1000);

             countdownEl.innerHTML = `**üíå ${days}** ng√†y **${hours}** gi·ªù **${minutes}** ph√∫t **${seconds}** gi√¢y`;
        }

        // --- KH·ªûI T·∫†O ---
        document.addEventListener('DOMContentLoaded', () => {
            initTym4();
            updateCountdown();
            setInterval(updateCountdown, 1000);

            if (sitePassword) {
                // N·∫øu ƒë√£ c√≥ m·∫≠t kh·∫©u, ·∫©n prompt v√† tr·ª±c ti·∫øp v√†o trang ch√≠nh (b·ªè qua b∆∞·ªõc b·∫•m l·∫ßn 2)
                document.getElementById('clickPrompt').style.display = 'none';
                document.getElementById('tym4-frame').classList.add('shrink');
                document.getElementById('mainContent').style.display = 'block';
                loadContent();
            } else {
                // Hi·ªÉn th·ªã prompt ƒë·ªÉ ng∆∞·ªùi d√πng b·∫•m v√†o
                document.getElementById('clickPrompt').style.display = 'block';
            }
        });

        // Enter ƒë·ªÉ ƒëƒÉng nh·∫≠p
        document.getElementById('sitePassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
    </script>
</body>
</html>
