<!DOCTYPE html>
<html lang="vi">
 <HEAD>
  <TITLE> Heart </TITLE>
  <META NAME="Generator" CONTENT="EditPlus">
  <META NAME="Author" CONTENT="">
  <META NAME="Keywords" CONTENT="">
  <META NAME="Description" CONTENT="">
  <link rel="stylesheet" href="style.css">
  <style>
  html, body {
    height: 100%;
    padding: 0;
    margin: 0;
    background: #000;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }
  
  /* BOX V√Ä PINKBOARD CH·ª®A HI·ªÜU ·ª®NG TIM G·ªêC (TYM 3) */
  .box {
    width: 100%;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    z-index: 10;
  }
  canvas {
    position: absolute;
    width: 100%;
    height: 100%;
  }
  #pinkboard {
    position: relative;
    margin: auto;
    height: 500px;
    width: 500px;
    animation: animate 1.3s infinite;
    z-index: 10;
  }

  /* Hi·ªáu ·ª©ng tr√°i tim CSS c·ªßa Tym 3 */
  #pinkboard:before, #pinkboard:after {
    content: '';
    position: absolute;
    background: #FF5CA4;
    width: 100px;
    height: 160px;
    border-top-left-radius: 50px;
    border-top-right-radius: 50px;
  }

  #pinkboard:before {
    left: 100px;
    transform: rotate(-45deg);
    transform-origin: 0 100%;
    box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
  }

  #pinkboard:after {
    left: 0;
    transform: rotate(45deg);
    transform-origin: 100% 100%;
  }

  @keyframes animate {
    0% { transform: scale(1); }
    30% { transform: scale(.8); }
    60% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  /* KHU V·ª∞C ·∫¢NH V√Ä N√öT (OVERLAY) */
  #content-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 20; 
      text-align: center;
  }
  
  .love-image-tym {
      width: 250px; height: 250px; object-fit: cover; border-radius: 50%;
      box-shadow: 0 0 15px rgba(255, 105, 180, 0.9); border: 5px solid white;
      display: none;
      /* Animation Heartbeat */
      animation: heartbeat-tym3 1.3s infinite; 
      transition: all 0.5s;
  }
  
  @keyframes heartbeat-tym3 {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
  }

  .navigation { position: fixed; bottom: 20px; z-index: 30; }
  </style>
 </HEAD>

 <BODY>
   <div class="box">
      <canvas id="pinkboard"></canvas>
   </div>
  
  <div id="content-overlay">
      <h1 style="color: white; text-shadow: 0 0 10px #ff69b4;">K·ª∑ Ni·ªám C·ªßa Ch√∫ng Ta! (Hi·ªáu ·ª©ng 3)</h1>
      <img id="loveImage" class="love-image-tym" style="display:none;">
      <p id="noImage" style="text-align: center; color: white; margin-top: 20px;">
          (ƒêang t·∫£i ·∫£nh...)
      </p>
      
      <div id="navigation" class="navigation" style="display:none;">
          <a href="/" class="btn" style="background: #2ed573;">üíå Quay v·ªÅ Trang Ch√≠nh</a>
          <button class="btn" onclick="logout()" style="background: #ff4757;">üö™ Kh√≥a Trang</button>
      </div>
  </div>
  
  <script>
  /*
   * Settings (ƒê·ªôc nh·∫•t c·ªßa Tym 3)
   */
  var settings = {
    particles: {
      length:   2000, // maximum amount of particles
      duration:   2, // particle duration in sec
      velocity: 100, // particle velocity in pixels/sec
      effect: -1.3, // play with this for a nice effect
      size:      13, // particle size in pixels
    },
  };

  /* --- ƒêO·∫†N CODE G·ªêC (GI·ªÆ NGUY√äN) --- */
  // ... (T·∫•t c·∫£ c√°c Class Point, Particle, ParticlePool, Polyfills gi·ªØ nguy√™n) ...
  // (T√¥i l∆∞·ª£c b·ªõt ·ªü ƒë√¢y cho g·ªçn)
  (function(){var b=0;var c=["ms","moz","webkit","o"];for(var a=0;a<c.length&&!window.requestAnimationFrame;++a){window.requestAnimationFrame=window[c[a]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[c[a]+"CancelAnimationFrame"]||window[c[a]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(h,e){var d=new Date().getTime();var f=Math.max(0,16-(d-b));var g=window.setTimeout(function(){h(d+f)},f);b=d+f;return g}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(d){clearTimeout(d)}}}());

  var Point = (function() {
    function Point(x, y) { this.x = (typeof x !== 'undefined') ? x : 0; this.y = (typeof y !== 'undefined') ? y : 0; }
    Point.prototype.clone = function() { return new Point(this.x, this.y); };
    Point.prototype.length = function(length) { if (typeof length == 'undefined') return Math.sqrt(this.x * this.x + this.y * this.y); this.normalize(); this.x *= length; this.y *= length; return this; };
    Point.prototype.normalize = function() { var length = this.length(); this.x /= length; this.y /= length; return this; };
    return Point;
  })();

  var Particle = (function() {
    function Particle() { this.position = new Point(); this.velocity = new Point(); this.acceleration = new Point(); this.age = 0; }
    Particle.prototype.initialize = function(x, y, dx, dy) { this.position.x = x; this.position.y = y; this.velocity.x = dx; this.velocity.y = dy; this.acceleration.x = dx * settings.particles.effect; this.acceleration.y = dy * settings.particles.effect; this.age = 0; };
    Particle.prototype.update = function(deltaTime) { this.position.x += this.velocity.x * deltaTime; this.position.y += this.velocity.y * deltaTime; this.velocity.x += this.acceleration.x * deltaTime; this.velocity.y += this.acceleration.y * deltaTime; this.age += deltaTime; };
    Particle.prototype.draw = function(context, image) { function ease(t) { return (--t) * t * t + 1; } var size = image.width * ease(this.age / settings.particles.duration); context.globalAlpha = 1 - this.age / settings.particles.duration; context.drawImage(image, this.position.x - size / 2, this.position.y - size / 2, size, size); };
    return Particle;
  })();

  var ParticlePool = (function() {
    var particles, firstActive = 0, firstFree   = 0, duration    = settings.particles.duration;
    function ParticlePool(length) { particles = new Array(length); for (var i = 0; i < particles.length; i++) particles[i] = new Particle(); }
    ParticlePool.prototype.add = function(x, y, dx, dy) { particles[firstFree].initialize(x, y, dx, dy); firstFree++; if (firstFree   == particles.length) firstFree   = 0; if (firstActive == firstFree       ) firstActive++; if (firstActive == particles.length) firstActive = 0; };
    ParticlePool.prototype.update = function(deltaTime) { var i; if (firstActive < firstFree) { for (i = firstActive; i < firstFree; i++) particles[i].update(deltaTime); } if (firstFree < firstActive) { for (i = firstActive; i < particles.length; i++) particles[i].update(deltaTime); for (i = 0; i < firstFree; i++) particles[i].update(deltaTime); } while (particles[firstActive].age >= duration && firstActive != firstFree) { firstActive++; if (firstActive == particles.length) firstActive = 0; } };
    ParticlePool.prototype.draw = function(context, image) { if (firstActive < firstFree) { for (i = firstActive; i < firstFree; i++) particles[i].draw(context, image); } if (firstFree < firstActive) { for (i = firstActive; i < particles.length; i++) particles[i].draw(context, image); for (i = 0; i < firstFree; i++) particles[i].draw(context, image); } };
    return ParticlePool;
  })();
  /* --- K·∫æT TH√öC CODE G·ªêC (GI·ªÆ NGUY√äN) --- */


  /*
   * Putting it all together (ƒê√É S·ª¨A CH·ªÆA PH·∫¶N RENDER)
   */
  (function(canvas) {
    var context = canvas.getContext('2d'),
        particles = new ParticlePool(settings.particles.length),
        particleRate = settings.particles.length / settings.particles.duration, // particles/sec
        time;
    
    function pointOnHeart(t) {
      return new Point( 160 * Math.pow(Math.sin(t), 3), 130 * Math.cos(t) - 50 * Math.cos(2 * t) - 20 * Math.cos(3 * t) - 10 * Math.cos(4 * t) + 25 );
    }
    
    var image = (function() {
      var canvas  = document.createElement('canvas'),
          context = canvas.getContext('2d');
      canvas.width  = settings.particles.size;
      canvas.height = settings.particles.size;
      function to(t) {
        var point = pointOnHeart(t);
        point.x = settings.particles.size / 2 + point.x * settings.particles.size / 350;
        point.y = settings.particles.size / 2 - point.y * settings.particles.size / 350;
        return point;
      }
      context.beginPath();
      var t = -Math.PI;
      var point = to(t);
      context.moveTo(point.x, point.y);
      while (t < Math.PI) {
        t += 0.01;
        point = to(t);
        context.lineTo(point.x, point.y);
      }
      context.closePath();
      context.fillStyle = '#FF5CA4';
      context.fill();
      var image = new Image();
      image.src = canvas.toDataURL();
      return image;
    })();
    
    function render() {
      requestAnimationFrame(render);
      var newTime   = new Date().getTime() / 1000,
          deltaTime = newTime - (time || newTime);
      time = newTime;
      
      // !!! ƒêI·ªÄU CH·ªàNH QUAN TR·ªåNG: L√ÄM N·ªÄN CANVAS TRONG SU·ªêT !!!
      // X√≥a n·ªÅn Canvas trong su·ªët, gi·ªØ nguy√™n hi·ªáu ·ª©ng Tym 3
      context.clearRect(0, 0, canvas.width, canvas.height); 
      
      var amount = particleRate * deltaTime;
      for (var i = 0; i < amount; i++) {
        var pos = pointOnHeart(Math.PI - 2 * Math.PI * Math.random());
        var dir = pos.clone().length(settings.particles.velocity);
        particles.add(canvas.width / 2 + pos.x, canvas.height / 2 - pos.y, dir.x, -dir.y);
      }
      
      particles.update(deltaTime);
      particles.draw(context, image);
    }
    
    function onResize() {
      canvas.width  = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
    }
    window.onresize = onResize;
    
    setTimeout(function() {
      onResize();
      render();
    }, 10);
  })(document.getElementById('pinkboard'));
  
  
  // ========================================================
  // LOGIC T·∫¢I ·∫¢NH V√Ä ƒêI·ªÄU H∆Ø·ªöNG
  // ========================================================

  let sitePassword = localStorage.getItem('sitePassword');

  async function loadContent() {
      // Logic t·∫£i ·∫£nh v√† ki·ªÉm tra m·∫≠t kh·∫©u gi·ªØ nguy√™n...
      try {
          if (!sitePassword) {
              alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p tr∆∞·ªõc ƒë·ªÉ xem k·ª∑ ni·ªám n√†y!');
              window.location.href = '/';
              return;
          }
          const imgResponse = await fetch('/api/love-image', { headers: { 'Authorization': sitePassword } });
          const loveImage = document.getElementById('loveImage');
          const noImage = document.getElementById('noImage');
          document.getElementById('navigation').style.display = 'block';

          if (imgResponse.ok) {
              const imgData = await imgResponse.json();
              if (imgData.image) {
                  loveImage.src = imgData.image;
                  loveImage.style.display = 'block';
                  noImage.style.display = 'none';
              } else {
                  noImage.textContent = 'Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c t·∫£i l√™n!';
                  noImage.style.display = 'block';
              }
          } else {
              noImage.textContent = 'L·ªói t·∫£i ·∫£nh ho·∫∑c ·∫£nh ch∆∞a ƒë∆∞·ª£c upload!';
              noImage.style.display = 'block';
          }
      } catch (error) {
          document.getElementById('noImage').textContent = 'L·ªói k·∫øt n·ªëi server.';
          document.getElementById('noImage').style.display = 'block';
      }
  }
  
  function logout() {
      localStorage.removeItem('sitePassword');
      window.location.href = '/'; 
  }

  document.addEventListener('DOMContentLoaded', loadContent);
  </script>
 </BODY>
</HTML>
