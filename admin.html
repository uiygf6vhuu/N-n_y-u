<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Thiết lập thông tin tình yêu</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            padding: 20px;
        }
        
        .container {
            background: rgba(0, 0, 0, 0.7);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.5);
            width: 100%;
            max-width: 500px;
        }
        
        h1 {
            color: #ff6b6b;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #ffcccb;
        }
        
        input[type="text"],
        input[type="date"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #333;
            background: #2e2e4e;
            color: white;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .image-preview-container {
            text-align: center;
            margin-top: 15px;
            border: 2px dashed #ff6b6b;
            padding: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
        }

        #imagePreview {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        
        .save-button {
            background: linear-gradient(to right, #ff6b6b, #ff8e8e);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            font-size: 18px;
            width: 100%;
            transition: background 0.3s;
        }
        
        .save-button:hover {
            background: linear-gradient(to right, #ff5252, #ff6b6b);
        }

        .back-button {
            background: #74b9ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 16px;
            width: 100%;
            transition: background 0.3s;
        }
        
        .upload-file-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .upload-file-group input[type="file"] {
            flex: 1;
            padding: 5px;
        }

        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            display: none;
            color: white;
        }
        
        .success {
            background: rgba(0, 255, 0, 0.2);
        }
        
        .error {
            background: rgba(255, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Thiết Lập Admin</h1>
        
        <div id="loginForm">
            <h2>Đăng nhập Admin</h2>
            <input type="password" id="adminPasswordLogin" placeholder="Nhập mật khẩu Admin">
            <button class="save-button" onclick="adminLogin()">Đăng nhập</button>
            <p id="loginMessage" class="message"></p>
        </div>

        <div id="adminContent" style="display: none;">
            <h2>1. Thông Tin Yêu Đương</h2>
            <div class="form-group">
                <label for="sitePassword">Mật khẩu trang chính (Sẽ được lưu trên Server):</label>
                <input type="password" id="sitePassword" placeholder="Thiết lập mật khẩu trang chính">
            </div>
            
            <div class="form-group">
                <label for="adminPassword">Mật khẩu Admin (Sẽ được lưu trên Server):</label>
                <input type="password" id="adminPassword" placeholder="Thiết lập mật khẩu Admin">
            </div>
            
            <div class="form-group">
                <label for="loverName">Tên người yêu (Lưu cục bộ):</label>
                <input type="text" id="loverName" placeholder="Nhập tên người yêu">
            </div>
            <div class="form-group">
                <label for="startDate">Ngày bắt đầu yêu (Lưu cục bộ):</label>
                <input type="date" id="startDate">
            </div>
            
            <button class="save-button" onclick="saveBasicSettings()">Lưu Thông Tin Cơ Bản</button>

            <h2>2. Quản Lý Thư Viện Ảnh</h2>
            <p style="font-size: 0.8em; color: #aaa; margin-bottom: 10px;">Các ảnh này sẽ được dùng cho slideshow và lưu trên Server.</p>

            <div class="form-group">
                <label for="imageUrl">Thêm ảnh bằng URL:</label>
                <input type="text" id="imageUrl" placeholder="Dán URL ảnh tại đây">
                <button class="save-button" style="margin-top: 10px; background: #2ecc71;" onclick="uploadImageFromUrl()">Thêm Ảnh từ URL</button>
            </div>
            
            <div class="form-group">
                <label for="imageFile">Tải ảnh lên từ thiết bị (Tối đa 5MB):</label>
                <div class="upload-file-group">
                    <input type="file" id="imageFile" accept="image/*">
                    <button class="save-button" style="margin-top: 0; width: auto; background: #3498db;" onclick="uploadImageFromFile()">Tải Lên Server</button>
                </div>
            </div>

            <div class="image-preview-container">
                <p>Danh sách ảnh hiện tại:</p>
                <div id="imageListDisplay">Chưa có ảnh nào được tải lên.</div>
            </div>
            
            <h2>3. Quản Lý Status</h2>
            <p style="font-size: 0.8em; color: #aaa;">Status được lưu trên Server. Chỉ có thể xóa status qua database/server.</p>
            <div id="statusList">
                </div>
            
            <button class="back-button" onclick="window.location.href='index (4).html'">Quay Lại Trang Chính</button>
        </div>
        
        <p id="message" class="message"></p>
    </div>

    <script>
        let adminToken = '';
        const MESSAGE_DURATION = 3000;

        function showMessage(text, isSuccess) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${isSuccess ? 'success' : 'error'}`;
            messageEl.style.display = 'block';
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, MESSAGE_DURATION);
        }

        async function adminLogin() {
            const password = document.getElementById('adminPasswordLogin').value;
            try {
                const response = await fetch('/api/admin-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();
                if (data.success) {
                    adminToken = password; // Sử dụng mật khẩu làm token xác thực (chỉ cho demo)
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('adminContent').style.display = 'block';
                    showMessage('Đăng nhập Admin thành công!', true);
                    loadData();
                } else {
                    showMessage(data.error || 'Đăng nhập thất bại', false);
                }
            } catch (error) {
                showMessage('Lỗi kết nối Server', false);
            }
        }

        async function saveBasicSettings() {
            if (!adminToken) return showMessage('Chưa đăng nhập Admin!', false);

            const sitePassword = document.getElementById('sitePassword').value;
            const adminPassword = document.getElementById('adminPassword').value;
            const loverName = document.getElementById('loverName').value;
            const startDate = document.getElementById('startDate').value;

            // 1. Lưu thông tin mật khẩu (Server)
            try {
                // Đổi mật khẩu trang chính
                if (sitePassword) {
                    await fetch('/api/change-site-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': adminToken },
                        body: JSON.stringify({ newPassword: sitePassword })
                    });
                }

                // Đổi mật khẩu Admin
                if (adminPassword) {
                    const response = await fetch('/api/change-admin-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': adminToken },
                        body: JSON.stringify({ newPassword: adminPassword })
                    });
                    if (response.ok) {
                         // Cập nhật token nếu mật khẩu admin được thay đổi thành công
                        adminToken = adminPassword; 
                    }
                }

                // 2. Lưu thông tin cục bộ (Client)
                localStorage.setItem('loverName', loverName);
                localStorage.setItem('startDate', startDate);
                
                showMessage('Đã lưu thiết lập thành công!', true);
            } catch (error) {
                showMessage('Lỗi khi lưu mật khẩu lên Server.', false);
            }
        }

        async function uploadImageFromUrl() {
            if (!adminToken) return showMessage('Chưa đăng nhập Admin!', false);
            const imageUrl = document.getElementById('imageUrl').value;
            
            try {
                const response = await fetch('/api/upload-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': adminToken },
                    body: JSON.stringify({ imageUrl })
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('Đã thêm ảnh từ URL thành công!', true);
                    document.getElementById('imageUrl').value = '';
                    await loadImages();
                } else {
                    showMessage(data.error || 'Lỗi thêm ảnh', false);
                }
            } catch (error) {
                showMessage('Lỗi kết nối Server khi upload URL.', false);
            }
        }

        async function uploadImageFromFile() {
            if (!adminToken) return showMessage('Chưa đăng nhập Admin!', false);
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];

            if (!file) {
                return showMessage('Vui lòng chọn một tệp ảnh.', false);
            }

            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('/api/upload-file', {
                    method: 'POST',
                    headers: { 'Authorization': adminToken },
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('Đã tải ảnh lên Server thành công!', true);
                    fileInput.value = '';
                    await loadImages();
                } else {
                    showMessage(data.error || 'Lỗi tải tệp', false);
                }
            } catch (error) {
                showMessage('Lỗi kết nối Server khi tải tệp.', false);
            }
        }

        async function loadImages() {
            // Không cần auth để lấy ảnh
            try {
                const response = await fetch('/api/love-images', {
                    method: 'GET',
                    headers: { 'Authorization': 'dummy' } // Dùng dummy auth vì API requireSiteAuth
                });
                
                const data = await response.json();
                const display = document.getElementById('imageListDisplay');
                
                if (data.success && data.images && data.images.length > 0) {
                    display.innerHTML = data.images.map((url, index) => `
                        <div style="margin-top: 10px; font-size: 0.9em; padding: 5px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                            #${index + 1}: <a href="${url}" target="_blank" style="color: #74b9ff; word-break: break-all;">${url.substring(0, 40)}...</a>
                        </div>
                    `).join('');
                    
                    // Cập nhật preview bằng ảnh đầu tiên
                    document.getElementById('imagePreview').src = data.images[0];
                    document.getElementById('imagePreview').style.display = 'block';
                } else {
                    display.textContent = 'Chưa có ảnh nào được tải lên.';
                    document.getElementById('imagePreview').style.display = 'none';
                }
            } catch (error) {
                console.error('Lỗi tải ảnh:', error);
                document.getElementById('imageListDisplay').textContent = 'Lỗi tải danh sách ảnh từ Server.';
            }
        }

        async function loadStatus() {
            // Không cần auth vì status được lưu ở index.html
            const statusListContainer = document.getElementById('statusList');
            statusListContainer.innerHTML = '<p>Tính năng xem status đang được triển khai (Server side).</p>';
            // Mặc dù file server.js có API messages, nhưng index.html lưu status cục bộ. 
            // Cần sửa index.html để sử dụng API messages cho tính đồng bộ.
        }

        async function loadData() {
            // Tải mật khẩu từ server (Chỉ để xem)
            try {
                const response = await fetch('/api/passwords', {
                    method: 'GET',
                    headers: { 'Authorization': adminToken }
                });

                const data = await response.json();
                if (data.success) {
                    document.getElementById('sitePassword').value = data.sitePassword;
                    document.getElementById('adminPassword').value = data.adminPassword;
                }
            } catch (error) {
                console.error('Lỗi tải mật khẩu:', error);
            }

            // Tải thông tin cục bộ
            document.getElementById('loverName').value = localStorage.getItem('loverName') || '';
            document.getElementById('startDate').value = localStorage.getItem('startDate') || '';

            loadImages();
            loadStatus();
        }

        window.onload = () => {
            // Để đơn giản, không tự động login. Bắt buộc nhập lại mật khẩu Admin.
        };
    </script>
</body>
</html>
